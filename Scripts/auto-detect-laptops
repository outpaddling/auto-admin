#!/bin/sh -e

pause()
{
    local junk
    
    printf "Press return to continue..."
    read junk
}

case $(auto-ostype) in
FreeBSD)
    if dmidecode | grep -iq macbook; then
	printf "$0: MacBook\n"
	# https://wiki.freebsd.org/AppleMacbook
	auto-set-conf-var atp_load '"YES"' /boot/loader.conf $0
	auto-set-conf-var acpi_video_load '"YES"' /boot/loader.conf $0
	auto-set-conf-var asmc_load '"YES"' /boot/loader.conf $0
	
	# Fix ~ and ` keys in /usr/local/share/X11/xkb/symbols/us-macbook
	xkb_dir=/usr/local/share/X11/xkb/symbols
	if [ ! -e $xkb_dir/us-macbook ]; then
	    cp $xkb_dir/us $xkb_dir/us-macbook
	fi
	cat << EOM

If your \` and ~ keys produce < and >, try swapping TLDE and LSGT in
the "mac" section of $xkb_dir/us-macbook.

EOM
	
	read -p "Remap right Cmd and Alt keys to Alt and Ctrl? y/[n] " remap
	if [ 0$remap = 0y ]; then
	    aa_dir=/usr/local/etc/auto-admin
	    mkdir -p $aa_dir
	    xsession=$aa_dir/xsession.macbook
	    cat << EOM > $xsession
# Do not edit this file
# auto-generated by $0
# Add additional files to $aa_dir for more customizations
# Run xev to verify Xorg scan codes
# Turn lower right "enter" key on older macs into a Ctrl key
xmodmap -e "keycode 108 = Control_R"
xmodmap -e "add control = Control_R"
    
# Turn right Command key into an Alt (Meta) key
xmodmap -e "keycode 134 = Meta_R Alt_R"
EOM
	    cat << EOM

Config saved to $xsession.
Source this from all Xsession and xinitrc files.

EOM
	fi
	# Swap LSGT and TLDE in /usr/local/share/X11/xkb/symbols/us
	cat << EOM > /etc/X11/xorg.conf.d/macbook-xkb.conf
Section "InputClass"
	Identifier "libinput keyboard catchall"
	MatchIsKeyboard "on"
	MatchDevicePath "/dev/input/event*"
	Driver "libinput"
	Option "XkbRules" "evdev"
	Option "XkbLayout" "us-macbook"
	Option "XkbVariant" "mac"
EndSection
EOM
	chmod 644 /etc/X11/xorg.conf.d/macbook-xkb.conf
    elif dmidecode | grep -iq thinkpad; then
	printf "$0: IBM/Lenovo ThinkPad\n"
    elif dmidecode | grep -iq "Product name: Satellite"; then
	printf "$0: Toshiba Satellite\n"
    fi
    ;;
    
*)
    auto-unsupported-os $0
    exit 1
    ;;

esac
